generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(dbgenerated("(gen_random_uuid())::text"))
  name             String
  email            String           @unique
  password         String
  role             user_role?       @default(STAFF)
  aktif            Boolean?         @default(true)
  created_at       DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?        @default(now()) @db.Timestamptz(6)
  login_activity   login_activity[]
  pay_components   PayComponent[]
  // kwitansi         Kwitansi[]
  // invoices         Invoice[]
  // Temporarily disabled payroll relationships for testing
  // approvedPayrolls PayrollRun[]     @relation("PayrollApprovedBy")
  // payrollRuns      PayrollRun[]

  @@index([aktif], map: "idx_users_aktif")
  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model KasBesarExpense {
  id            String    @id @default(cuid())
  hari          String
  tanggal       String
  bulan         String
  tipeAktivitas String    @map("tipe_aktivitas")
  barang        String
  banyak        Float
  satuan        String
  hargaSatuan   Float     @map("harga_satuan")
  total         Float
  vendorNama    String    @map("vendor_nama")
  vendorTelp    String?   @map("vendor_telp")
  vendorEmail   String?   @map("vendor_email")
  jenis         String    @default("kas_besar")
  subJenis      String    @map("sub_jenis")
  buktiUrl      String?   @map("bukti_url")
  kontrakUrl    String?   @map("kontrak_url")
  status        Status    @default(DRAFT)
  notes         String?
  approvalNotes String?   @map("approval_notes")
  createdBy     String
  approvedBy    String?   @map("approved_by")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? @map("deleted_at")

  @@map("kas_besar_expenses")
}

model KasKecilExpense {
  id            String    @id @default(cuid())
  hari          String
  tanggal       String
  bulan         String
  tipeAktivitas String    @map("tipe_aktivitas")
  barang        String
  banyak        Float
  satuan        String
  hargaSatuan   Float     @map("harga_satuan")
  total         Float
  vendorNama    String    @map("vendor_nama")
  vendorTelp    String?   @map("vendor_telp")
  vendorEmail   String?   @map("vendor_email")
  jenis         String    @default("kas_kecil")
  subJenis      String    @map("sub_jenis")
  buktiUrl      String?   @map("bukti_url")
  status        Status    @default(DRAFT)
  notes         String?
  approvalNotes String?   @map("approval_notes")
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? @map("deleted_at")

  @@map("kas_kecil_expenses")
}

model Employee {
  id                  String                       @id @default(dbgenerated("(gen_random_uuid())::text"))
  nama                String
  nik                 String?
  jabatan             String?
  site                String
  tempatLahir         String?                      @map("tempat_lahir")
  tanggalLahir        String?                      @map("tanggal_lahir")
  alamat              String?
  kontrakUpahHarian   Decimal                      @map("kontrak_upah_harian") @db.Decimal(15, 2)
  defaultUangMakan    Decimal                      @default(0) @map("default_uang_makan") @db.Decimal(15, 2)
  defaultUangBbm      Decimal                      @default(0) @map("default_uang_bbm") @db.Decimal(15, 2)
  bankName            String?                      @map("bank_name")
  bankAccount         String?                      @map("bank_account")
  npwp                String?
  startDate           String?                      @map("start_date")
  aktif               Boolean?                     @default(true)
  created_at          DateTime?                    @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?                    @default(now()) @db.Timestamptz(6)
  createdAt           DateTime?                    @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime?                    @default(now()) @db.Timestamptz(6)
  componentSelections EmployeeComponentSelection[]
  payrollLines        PayrollLine[]

  @@index([aktif], map: "idx_employees_aktif")
  @@index([nama], map: "idx_employees_nama")
  @@index([site], map: "idx_employees_site")
  @@map("employees")
}

model PayComponent {
  id                    String                       @id @default(dbgenerated("(gen_random_uuid())::text"))
  nama                  String
  taxable               Boolean?                     @default(false)
  rate                  Decimal?                     @db.Decimal(8, 4)
  nominal               Decimal?                     @db.Decimal(15, 2)
  capMin                Decimal?                     @map("cap_min") @db.Decimal(15, 2)
  capMax                Decimal?                     @map("cap_max") @db.Decimal(15, 2)
  order                 Int?                         @default(0)
  aktif                 Boolean?                     @default(true)
  created_by            String?
  created_at            DateTime?                    @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?                    @default(now()) @db.Timestamptz(6)
  createdAt             DateTime?                    @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime?                    @default(now()) @db.Timestamptz(6)
  tipe                  pay_component_type
  metode                pay_component_method
  basis                 pay_component_basis
  componentSelections   EmployeeComponentSelection[]
  users                 User?                        @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payrollLineComponents PayrollLineComponent[]

  @@index([aktif], map: "idx_pay_components_aktif")
  @@index([created_by], map: "idx_pay_components_created_by")
  @@index([order], map: "idx_pay_components_order")
  @@map("pay_components")
}

model AttendanceRecord {
  id            String           @id @default(cuid())
  employeeId    String           @map("employee_id")
  tanggal       String
  clockIn       String?          @map("clock_in")
  clockOut      String?          @map("clock_out")
  breakStart    String?          @map("break_start")
  breakEnd      String?          @map("break_end")
  totalHours    Float            @map("total_hours")
  status        AttendanceStatus
  overtimeHours Float            @default(0) @map("overtime_hours")
  notes         String?
  approvedBy    String?          @map("approved_by")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@map("attendance_records")
}

model PayrollRun {
  id                  String                       @id @default(dbgenerated("(gen_random_uuid())::text"))
  periodeAwal         String                       @map("periode_awal")
  periodeAkhir        String                       @map("periode_akhir")
  status              payroll_status?              @default(DRAFT)
  createdBy           String                       @map("created_by")
  approvedBy          String?                      @map("approved_by")
  notes               String?
  customFileName      String?                      @map("custom_file_name") @db.VarChar(1000)
  created_at          DateTime?                    @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?                    @default(now()) @db.Timestamptz(6)
  deletedAt           DateTime?                    @map("deleted_at") @db.Timestamptz(6)
  componentSelections EmployeeComponentSelection[]
  payrollLines        PayrollLine[]
  // Temporarily disabled foreign key constraints for testing
  // approver            User?                        @relation("PayrollApprovedBy", fields: [approvedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  // creator             User                         @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_payroll_runs_created_at")
  @@index([createdBy], map: "idx_payroll_runs_created_by")
  @@index([periodeAwal, periodeAkhir], map: "idx_payroll_runs_periode")
  @@index([status], map: "idx_payroll_runs_status")
  @@map("payroll_runs")
}

model PayrollLine {
  id              String                 @id @default(dbgenerated("(gen_random_uuid())::text"))
  payrollRunId    String                 @map("payroll_run_id")
  employeeId      String                 @map("employee_id")
  employeeName    String                 @map("employee_name")
  hariKerja       Int                    @default(0) @map("hari_kerja")
  upahHarian      Decimal                @default(0) @map("upah_harian") @db.Decimal(15, 2)
  uangMakanHarian Decimal                @default(0) @map("uang_makan_harian") @db.Decimal(15, 2)
  uangBbmHarian   Decimal                @default(0) @map("uang_bbm_harian") @db.Decimal(15, 2)
  overtimeHours   Decimal?               @default(0) @map("overtime_hours") @db.Decimal(8, 2)
  overtimeRate    Decimal?               @default(1.5) @map("overtime_rate") @db.Decimal(8, 4)
  overtimeAmount  Decimal?               @default(0) @map("overtime_amount") @db.Decimal(15, 2)
  normalHours     Decimal?               @default(0) @map("normal_hours") @db.Decimal(8, 2)
  holidayHours    Decimal?               @default(0) @map("holiday_hours") @db.Decimal(8, 2)
  nightFirstHour  Decimal?               @default(0) @map("night_first_hour") @db.Decimal(8, 2)
  nightAdditionalHours Decimal?          @default(0) @map("night_additional_hours") @db.Decimal(8, 2)
  customHourlyRate Decimal?              @default(0) @map("custom_hourly_rate") @db.Decimal(15, 2)
  cashbon         Decimal?               @default(0) @db.Decimal(15, 2)
  bruto           Decimal                @default(0) @db.Decimal(15, 2)
  pajakRate       Decimal?               @map("pajak_rate") @db.Decimal(8, 4)
  pajakNominal    Decimal?               @map("pajak_nominal") @db.Decimal(15, 2)
  potonganLain    Decimal?               @default(0) @map("potongan_lain") @db.Decimal(15, 2)
  neto            Decimal                @default(0) @db.Decimal(15, 2)
  status          payroll_status?        @default(DRAFT)
  notes           String?
  created_at      DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?              @default(now()) @db.Timestamptz(6)
  deletedAt       DateTime?              @map("deleted_at") @db.Timestamptz(6)
  components      PayrollLineComponent[]
  employee        Employee               @relation(fields: [employeeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payrollRun      PayrollRun             @relation(fields: [payrollRunId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([employeeId], map: "idx_payroll_lines_employee_id")
  @@index([payrollRunId], map: "idx_payroll_lines_run_id")
  @@index([status], map: "idx_payroll_lines_status")
  @@map("payroll_lines")
}

model PayrollLineComponent {
  id            String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  payrollLineId String       @map("payroll_line_id")
  componentId   String       @map("component_id")
  componentName String       @map("component_name")
  qty           Decimal?     @db.Decimal(8, 2)
  rate          Decimal?     @db.Decimal(8, 4)
  nominal       Decimal?     @db.Decimal(15, 2)
  amount        Decimal      @db.Decimal(15, 2)
  taxable       Boolean?     @default(false)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  payComponent  PayComponent @relation(fields: [componentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payrollLine   PayrollLine  @relation(fields: [payrollLineId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([payrollLineId, componentId])
  @@index([componentId], map: "idx_payroll_line_components_component_id")
  @@index([payrollLineId], map: "idx_payroll_line_components_line_id")
  @@map("payroll_line_components")
}

model EmployeeComponentSelection {
  id            String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  payrollRunId  String       @map("payroll_run_id")
  employeeId    String       @map("employee_id")
  componentId   String       @map("component_id")
  componentType String       @map("component_type")
  isSelected    Boolean?     @default(true) @map("is_selected")
  customAmount  Decimal?     @map("custom_amount") @db.Decimal(15, 2)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  component     PayComponent @relation(fields: [componentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  employee      Employee     @relation(fields: [employeeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payrollRun    PayrollRun   @relation(fields: [payrollRunId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([payrollRunId, employeeId, componentId])
  @@index([componentId], map: "idx_employee_selections_component_id")
  @@index([employeeId], map: "idx_employee_selections_employee_id")
  @@index([payrollRunId], map: "idx_employee_selections_run_id")
  @@map("employee_component_selections")
}

model Kwitansi {
  id                String    @id @default(cuid())
  nomorKwitansi     String    @map("nomor_kwitansi")
  tanggal           String
  namaPenerima      String    @map("nama_penerima")
  jumlahUang        Float     @map("jumlah_uang")
  untukPembayaran   String    @map("untuk_pembayaran")
  namaPembayar      String    @map("nama_pembayar")
  nomorRekening     String?   @map("nomor_rekening")
  namaRekening      String?   @map("nama_rekening")
  bankName          String?   @map("bank_name")
  transferMethod    String?   @map("transfer_method")
  tempat            String
  tanggalKwitansi   String    @map("tanggal_kwitansi")
  signatureName     String    @map("signature_name")
  signaturePosition String    @map("signature_position")
  materai           String?
  headerImage       String?   @map("header_image")
  payrollRunId      String?   @map("payroll_run_id")
  payrollLineId     String?   @map("payroll_line_id")
  employeeId        String?   @map("employee_id")
  createdBy         String    @map("created_by")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? @map("deleted_at")

  // Relations temporarily disabled for testing
  // creator           User?     @relation(fields: [createdBy], references: [id])

  @@map("kwitansi")
}

model Invoice {
  id                String    @id @default(cuid())
  invoiceNumber     String    @map("invoice_number")
  createdDate       String    @map("created_date")
  dueDate           String?   @map("due_date")
  applicantName     String    @map("applicant_name")
  recipientName     String    @map("recipient_name")
  notes             String?
  termsConditions   String?   @map("terms_conditions")
  headerImage       String?   @map("header_image")
  showBankDetails   Boolean   @default(false) @map("show_bank_details")
  bankName          String?   @map("bank_name")
  accountNumber     String?   @map("account_number")
  accountHolder     String?   @map("account_holder")
  transferMethod    String?   @map("transfer_method")
  signatureName     String?   @map("signature_name")
  signaturePosition String?   @map("signature_position")
  signatureLocation String?   @map("signature_location")
  items             Json      // Store invoice items as JSON
  subtotal          Float     @default(0)
  discount          Float     @default(0)
  tax               Float     @default(0)
  total             Float     @default(0)
  createdBy         String    @map("created_by")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime? @map("deleted_at")

  // Relations temporarily disabled for testing
  // creator           User      @relation(fields: [createdBy], references: [id])

  @@map("invoices")
}

model ProductionReport {
  id          String           @id @default(cuid())
  tanggal     String
  nopol       String
  pembeliId   String?          @map("pembeli_id")
  pembeliNama String           @map("pembeli_nama")
  tujuan      String
  grossTon    Float            @map("gross_ton")
  tareTon     Float            @map("tare_ton")
  nettoTon    Float            @map("netto_ton")
  sourceFile  String?          @map("source_file")
  notes       String?
  status      ProductionStatus @default(DRAFT)
  createdBy   String           @map("created_by")
  approvedBy  String?          @map("approved_by")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?        @map("deleted_at")
  buyer       Buyer?           @relation(fields: [pembeliId], references: [id])

  @@map("production_reports")
}

model Buyer {
  id                 String             @id @default(cuid())
  nama               String
  hargaPerTonDefault Float?             @map("harga_per_ton_default")
  alamat             String?
  telepon            String?
  email              String?
  npwp               String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  aktif              Boolean            @default(true)
  productionReports  ProductionReport[]

  @@map("buyers")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  tableName String   @map("table_name")
  recordId  String   @map("record_id")
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  userId    String   @map("user_id")
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model login_activities {
  id         String      @id
  user_id    String
  email      String
  ip_address String?
  user_agent String?
  status     LoginStatus @default(SUCCESS)
  createdAt  DateTime    @default(now())
}

model RunsProfile {
  id                     String             @id @default(cuid())
  userId                 String             @unique @map("user_id")
  orgId                  String?            @map("org_id")
  fullName               String             @map("full_name")
  jobTitle               String             @map("job_title")
  preferredLang          String             @map("preferred_lang")
  preferredFormats       String[]           @map("preferred_formats")
  reminderChannel        String             @map("reminder_channel")
  signatureName          String             @map("signature_name")
  hasCompletedOnboarding Boolean            @default(false) @map("has_completed_onboarding")
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  onboardingAnswers      OnboardingAnswers?
  personalBest           PersonalBest[]

  @@map("runs_profile")
}

model OnboardingAnswers {
  id                 String      @id @default(cuid())
  orgId              String?     @map("org_id")
  userId             String      @unique @map("user_id")
  language           String
  reportFormats      Json        @map("report_formats")
  commonExpenses     Json        @map("common_expenses")
  budgetAlerts       Boolean     @map("budget_alerts")
  monthlyTargetMt    Float?      @map("monthly_target_mt")
  showTargetVsActual Boolean     @map("show_target_vs_actual")
  payrollModes       Json        @map("payroll_modes")
  payrollComponents  Json        @map("payroll_components")
  inputDevices       Json        @map("input_devices")
  reminderChannel    String      @map("reminder_channel")
  sampleReportFileId String?     @map("sample_report_file_id")
  allowCustomNotes   Boolean     @map("allow_custom_notes")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  runsProfile        RunsProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("onboarding_answers")
}

model PersonalBest {
  id           String      @id @default(cuid())
  orgId        String?     @map("org_id")
  userId       String      @map("user_id")
  title        String
  notes        String?
  sampleFileId String?     @map("sample_file_id")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  runsProfile  RunsProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("personal_best")
}

model Files {
  id          String   @id @default(cuid())
  filename    String
  storagePath String   @map("storage_path")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("files")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model login_activity {
  id         String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id    String?
  email      String
  ip_address String?
  user_agent String?
  status     login_status
  created_at DateTime?    @default(now()) @db.Timestamptz(6)
  users      User?        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_login_activity_created_at")
  @@index([status], map: "idx_login_activity_status")
  @@index([user_id], map: "idx_login_activity_user_id")
}

enum Status {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
  ARCHIVED
  REJECTED
}

enum PayComponentType {
  EARNING
  DEDUCTION
}

enum PayComponentMethod {
  FLAT
  PER_HARI
  PERSENTASE
}

enum PayComponentBasis {
  UPAH_HARIAN
  BRUTO
  HARI_KERJA
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  SICK
  LEAVE
}

enum PayrollStatus {
  DRAFT
  REVIEWED
  APPROVED
  PAID
  ARCHIVED
}

enum ProductionStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
  ARCHIVED
}

enum LoginStatus {
  SUCCESS
  FAILED
  LOCKED
  LOGOUT
}

enum login_status {
  LOGIN
  LOGOUT
  FAILED
}

enum pay_component_basis {
  UPAH_HARIAN
  BRUTO
  HARI_KERJA
}

enum pay_component_method {
  FLAT
  PER_HARI
  PERSENTASE
}

enum pay_component_type {
  EARNING
  DEDUCTION
}

enum payroll_status {
  DRAFT
  SUBMITTED
  APPROVED
  PAID
  REJECTED
}

enum user_role {
  ADMIN
  MANAGER
  STAFF
  DEMO
}
